<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metallindex | Händlerpreise & Portfolio</title>
    <meta name="description" content="Aktuelle Händlerpreise für Gold, Silber, Platin und Palladium. Portfolio-Management.">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. DESIGN SYSTEM (Premium Fintech Look) --- */
        :root {
            /* Palette: Deep Navy & Champagne Gold */
            --c-primary: #c5a059;
            --c-primary-dark: #a38234;
            --c-bg-app: #0b1120;
            --c-bg-card: #151e32;
            --c-text-main: #f1f5f9;
            --c-text-muted: #94a3b8;
            --c-border: #334155;
            --c-success: #10b981;
            --c-danger: #ef4444;
            /* Metals Colors */
            --color-gold: #c5a059;
            --color-silver: #cbd5e1;
            --color-plat: #e2e8f0;
            --color-pall: #a8a29e;
            /* Metrics */
            --radius-md: 6px;
            --radius-lg: 12px;
            --font-stack: 'Inter', sans-serif;
            --nav-height: 70px;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--c-bg-app);
            color: var(--c-text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- 2. LAYOUT & GRID --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .grid-dashboard {
            display: grid;
            gap: 24px;
            grid-template-columns: 1fr;
        }

        @media(min-width: 1024px) {
            .grid-dashboard {
                grid-template-columns: 340px 1fr; /* Sidebar links, Content rechts */
            }
        }

        .hidden-section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- 3. COMPONENTS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid transparent;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-dark) 100%);
            color: #000;
            font-weight: 600;
        }

            .btn-primary:hover {
                filter: brightness(1.05);
            }

        .btn-outline {
            background: transparent;
            border-color: var(--c-border);
            color: var(--c-text-muted);
        }

            .btn-outline:hover, .btn-outline.active {
                border-color: var(--c-primary);
                color: var(--c-primary);
            }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        /* Cards */
        .card {
            background: var(--c-bg-card);
            border: 1px solid var(--c-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .card-title i {
                color: var(--c-primary);
            }

        /* Inputs */
        .form-control {
            width: 100%;
            background: var(--c-bg-app);
            border: 1px solid var(--c-border);
            color: white;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            font-family: var(--font-stack);
            margin-bottom: 15px;
        }

            .form-control:focus {
                outline: none;
                border-color: var(--c-primary);
            }

        .input-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--c-text-muted);
            margin-bottom: 6px;
            display: block;
        }

        /* Typography */
        .big-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--c-primary);
            line-height: 1.1;
        }

        .sub-price {
            font-size: 0.85rem;
            color: var(--c-text-muted);
        }

        /* Source Badge */
        .source-badge {
            font-size: 0.75rem;
            background: rgba(255,255,255,0.03);
            padding: 6px 10px;
            border-radius: 6px;
            color: var(--c-text-muted);
            border: 1px solid var(--c-border);
            display: inline-block;
            margin-bottom: 12px;
        }

        /* --- 4. NAVIGATION --- */
        .navbar {
            background: rgba(11,17,32,0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--c-border);
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--nav-height);
        }

        .nav-inner {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-logo {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: opacity 0.15s;
        }

            .brand-logo span {
                color: var(--c-primary);
            }

        .nav-menu {
            display: flex;
            gap: 6px;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: var(--radius-md);
            color: var(--c-text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.12s;
        }

            .nav-item:hover {
                color: #fff;
                background: rgba(255,255,255,0.04);
            }

            .nav-item.active {
                background: var(--c-primary);
                color: #000;
                font-weight: 600;
            }

        /* --- 5. CALCULATOR --- */
        .calc-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--c-bg-app);
            padding: 6px;
            border-radius: var(--radius-md);
        }

        .calc-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            color: var(--c-text-muted);
            border-radius: 6px;
        }

            .calc-tab.active {
                background: var(--c-bg-card);
                color: var(--c-primary);
                font-weight: 600;
                box-shadow: 0 1px 3px rgba(0,0,0,0.25);
            }

        .inventory-list {
            margin-top: 10px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--c-bg-app);
            border-bottom: 1px solid var(--c-border);
        }

            .inventory-item:last-child {
                border-bottom: none;
            }

        /* --- 6. LOGIN --- */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: var(--c-bg-app);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: var(--c-bg-card);
            padding: 32px;
            width: 100%;
            max-width: 420px;
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--c-border);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.6);
        }

        /* --- 7. RESPONSIVE & MOBILE UX --- */
        /* Make touch targets bigger */
        @media (max-width: 768px) {
            .btn {
                padding: 12px 16px;
            }

            .nav-menu {
                display: none;
            }

            #hamburger {
                display: inline-flex;
            }

            .container {
                padding: 0 12px;
            }

            .card {
                padding: 18px;
            }

            .big-price {
                font-size: 1.6rem;
            }

            .grid-dashboard {
                gap: 14px;
            }

            .sidebar {
                order: -1;
            }

            .tradingview-widget-container {
                height: 220px !important;
            }

            footer {
                padding: 24px 0;
            }

            .btn-sm {
                padding: 8px 12px;
            }
        }

        /* mobile nav drawer */
        #mobile-nav {
            display: none;
            position: absolute;
            top: var(--nav-height);
            left: 0;
            right: 0;
            background: var(--c-bg-card);
            border-bottom: 1px solid var(--c-border);
            padding: 12px;
            z-index: 150;
        }

            #mobile-nav .nav-item {
                display: block;
                padding: 10px 12px;
                border-radius: 8px;
                margin-bottom: 6px;
            }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <i class="fa-solid fa-layer-group" style="font-size: 3rem; color: var(--c-primary); margin-bottom: 20px;"></i>
            <h2 style="margin: 0 0 10px 0;">Metallindex</h2>
            <p style="color: var(--c-text-muted); margin-bottom: 20px;">Institutional Access</p>

            <div style="text-align: left;">
                <label class="input-label">Zugangscode</label>
                <input type="password" id="passwordInput" class="form-control" placeholder="••••••••" onkeydown="if(event.key === 'Enter') checkPassword()">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top:8px;" onclick="checkPassword()">
                Login <i class="fa-solid fa-arrow-right"></i>
            </button>
            <p id="loginError" style="color: var(--c-danger); margin-top: 15px; display: none;">Zugriff verweigert.</p>
        </div>
    </div>

    <div id="main-app" style="display:none;">

        <nav class="navbar">
            <div class="container nav-inner">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="brand-logo" onclick="switchView('dashboard')" title="Zur Startseite">
                        <i class="fa-solid fa-layer-group"></i> Metall<span>index</span>
                    </div>

                    <button id="hamburger" class="btn btn-outline" style="display:none;" onclick="toggleMobileNav()"><i class="fa-solid fa-bars"></i></button>
                </div>

                <div class="nav-menu">
                    <div class="nav-item active" id="nav-dash" onclick="switchView('dashboard')">Marktübersicht</div>
                    <div class="nav-item" id="nav-calc" onclick="switchView('calculator')">Portfolio Rechner</div>
                    <div class="nav-item" id="nav-ana" onclick="switchView('analysis')">Research</div>
                </div>

                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size:0.8rem; color:var(--c-text-muted);">Basis: EUR</span>
                </div>
            </div>
            <div id="mobile-nav"></div>
        </nav>

        <div style="height: 40px; background: #000; border-bottom: 1px solid var(--c-border);">
            <div class="tradingview-widget-container">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                {
                "symbols": [
                    { "proName": "FOREXCOM:XAUUSD", "title": "Gold Spot $" },
                    { "proName": "FOREXCOM:XAGUSD", "title": "Silber Spot $" },
                    { "proName": "TVC:PLATINUM", "title": "Platin Spot $" },
                    { "proName": "TVC:PALLADIUM", "title": "Palladium Spot $" }
                ],
                "colorTheme": "dark", "isTransparent": true, "displayMode": "regular", "locale": "de_DE"
                }
                </script>
            </div>
        </div>

        <div class="container" style="padding-top: 20px; padding-bottom: 50px;">

            <div id="dashboard" class="hidden-section" style="display: block;">
                <div class="grid-dashboard">
                    <div class="sidebar" style="display: flex; flex-direction: column; gap: 18px;">

                        <div class="card" style="border-left: 4px solid var(--c-primary);">
                            <div class="source-badge"><i class="fa-solid fa-building-columns"></i> Händler Ankaufspreis (Referenz: Philoro)</div>
                            <div class="input-label">Gold 1 oz (Philharmoniker)</div>
                            <div class="big-price" id="dash-gold">...</div>
                            <div class="sub-price">abzüglich spread</div>
                        </div>

                        <!-- Vergleich: Andere 1oz Münzen (übliches Verhältnis zur Philharmoniker) -->
                        <div class="card" style="padding:12px;">
                            <div class="card-title" style="font-size:0.95rem; margin-bottom:8px;"><i class="fa-solid fa-coins"></i> Vergleich: 1 oz Münzen</div>
                            <div id="coin-compare" style="display:flex; flex-direction:column; gap:8px; font-size:0.95rem; color:var(--c-text-muted);"></div>
                        </div>

                        <div class="card" style="border-left: 4px solid var(--color-silver);">
                            <div class="input-label">Silber 1 oz (Münze)</div>
                            <div class="big-price" id="dash-silver" style="color: var(--color-silver);">...</div>
                            <div class="sub-price">Differenzbesteuert</div>
                        </div>

                        <div class="grid-2" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <div class="card" style="padding:12px; border-left: 4px solid var(--color-plat);">
                                <div class="input-label">Platin 1oz</div>
                                <div style="font-size:1.1rem; font-weight:700; color: var(--color-plat);" id="dash-plat">...</div>
                            </div>
                            <div class="card" style="padding:12px; border-left: 4px solid var(--color-pall);">
                                <div class="input-label">Palladium 1oz</div>
                                <div style="font-size:1.1rem; font-weight:700; color: var(--color-pall);" id="dash-pall">...</div>
                            </div>
                        </div>

                        <div style="font-size:0.75rem; color:var(--c-text-muted); text-align:center;">
                            Preise aktualisiert am: <span id="update-date">...</span>
                        </div>
                    </div>

                    <div class="main-content">
                        <div class="card" style="height: 560px;">
                            <div class="card-header">
                                <div class="card-title"><i class="fa-solid fa-chart-area"></i> Spot Markt Entwicklung</div>
                            </div>
                            <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
                                <div class="tradingview-widget-container__widget" style="height: 100%;"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
                                {
                                "symbols": [
                                    ["Gold", "FOREXCOM:XAUUSD|1D"],
                                    ["Silber", "FOREXCOM:XAGUSD|1D"],
                                    ["Platin", "TVC:PLATINUM|1D"],
                                    ["Palladium", "TVC:PALLADIUM|1D"]
                                ],
                                "chartOnly": false, "width": "100%", "height": "100%", "locale": "de_DE",
                                "colorTheme": "dark", "autosize": true, "showVolume": false, "hideDateRanges": false,
                                "scalePosition": "right", "backgroundColor": "#151e32"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="calculator" class="hidden-section">
                <div class="grid-dashboard">

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Bestand erweitern</div>
                            <button class="btn btn-outline btn-sm" onclick="clearPortfolio()">Reset</button>
                        </div>

                        <div class="calc-tabs">
                            <div class="calc-tab active" id="tab-cat" onclick="toggleCalcMode('catalog')">Katalog Auswahl</div>
                            <div class="calc-tab" id="tab-raw" onclick="toggleCalcMode('raw')">Manuell (Gramm)</div>
                        </div>

                        <div id="mode-catalog">
                            <label class="input-label">Metallart filtern</label>
                            <div style="display:flex; gap:5px; margin-bottom:15px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('all')">Alle</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('gold')" style="color:var(--color-gold); border-color:var(--color-gold);">Au</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('silver')" style="color:var(--color-silver); border-color:var(--color-silver);">Ag</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('platinum')" style="color:var(--color-plat); border-color:var(--color-plat);">Pt</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('palladium')" style="color:var(--color-pall); border-color:var(--color-pall);">Pd</button>
                            </div>

                            <label class="input-label">Produkt wählen</label>
                            <select id="catalogSelect" class="form-control" onchange="updateCatDetails()"></select>

                            <div style="display:flex; gap:10px;">
                                <div style="flex:1;">
                                    <label class="input-label">Anzahl</label>
                                    <input type="number" id="cat-qty" class="form-control" value="1" min="1">
                                </div>
                                <div style="flex:1;">
                                    <label class="input-label">Einzelpreis (Est.)</label>
                                    <input type="text" id="cat-price-display" class="form-control" disabled style="opacity: 0.9; color: var(--c-primary);">
                                </div>
                            </div>
                        </div>

                        <div id="mode-raw" style="display:none;">
                            <label class="input-label">Metall</label>
                            <select id="raw-metal" class="form-control">
                                <option value="gold">Gold</option>
                                <option value="silver">Silber</option>
                                <option value="platinum">Platin</option>
                                <option value="palladium">Palladium</option>
                            </select>
                            <label class="input-label">Gewicht (Gramm)</label>
                            <input type="number" id="raw-weight" class="form-control" placeholder="z.B. 31.1">
                            <label class="input-label">Feinheit</label>
                            <select id="raw-purity" class="form-control">
                                <option value="0.999">999 (Fein)</option>
                                <option value="0.916">916 (22k)</option>
                                <option value="0.750">750 (18k)</option>
                                <option value="0.585">585 (14k)</option>
                            </select>
                        </div>

                        <div style="margin-top: 10px; border-top: 1px solid var(--c-border); padding-top: 18px;">
                            <label class="input-label">Bewertungs-Basis</label>
                            <select id="spread-select" class="form-control">
                                <option value="1.0">Aktueller Händler-Verkaufspreis (Wiederbeschaffung)</option>
                                <option value="0.95">Händler Ankauf (ca. -5%)</option>
                                <option value="0.0">Spot Preis (Börsenwert)</option>
                            </select>
                            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="addToPortfolio()">Zur Liste hinzufügen</button>
                        </div>
                    </div>

                    <div class="card" style="display:flex; flex-direction:column;">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-vault"></i> Mein Portfolio</div>
                            <div id="port-count" style="font-size:0.9rem; color:var(--c-text-muted);">0 Positionen</div>
                        </div>

                        <div id="portfolio-container" style="flex-grow:1; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                            <p style="text-align:center; color: var(--c-text-muted); padding-top: 40px;">Noch keine Einträge.</p>
                        </div>

                        <div style="background: rgba(197, 160, 89, 0.08); padding: 16px; border-radius: var(--radius-lg); border: 1px solid rgba(197, 160, 89, 0.18); text-align: right;">
                            <div class="sub-price">Gesamtwert Portfolio</div>
                            <div class="big-price" id="total-value">0,00 €</div>
                            <div class="sub-price" style="margin-top:5px; font-size:0.75rem;">Basierend auf hinterlegten Tagespreisen</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis" class="hidden-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Marktkommentar & Analyse</div>
                    </div>
                    <p style="color:var(--c-text-muted);">Hier können manuelle Marktanalysen stehen...</p>
                </div>
            </div>

        </div>
        <footer style="background: var(--c-bg-card); border-top: 1px solid var(--c-border); padding: 36px 0; text-align: center; color: var(--c-text-muted); font-size: 0.9rem;">
            <div class="container">
                <div style="margin-bottom: 10px;"><i class="fa-solid fa-layer-group" style="color:var(--c-primary);"></i> Metallindex Group</div>
                <p>&copy; 2025. Alle Rechte vorbehalten.<br>Die angezeigten Preise sind indikative Händlerpreise basierend auf manuellen Tageswerten.</p>
            </div>
        </footer>
    </div>

    <script>
        // =========================================================================
        // --- 1. KONFIGURATION (MORGEN-UPDATE HIER EINTRAGEN) ---
        // =========================================================================
        // Bitte hier jeden Morgen die aktuellen "Unzen-Preise" (Spot) in EUR eintragen.
        // Das Script berechnet die Münzpreise automatisch mit Aufschlägen.

        const DAILY_SPOT_EUR = {
            gold: 3625,
            silver: 60,
            platinum: 1650,
            palladium: 1300
        };

        const LAST_UPDATE = "31.12.2025, 08:30 Uhr"; // Datum eintragen

        // =========================================================================

        // --- PREISE / PREMIUMS ---
        // Premiums sind Multiplikatoren auf den Spotpreis (z.B. 1.05 = +5%)
        const PREMIUMS = {
            gold_coin: 1,    // +5% on spot
            gold_bar: 1,
            silver_coin: 1,  // higher due to minting / VAT / handling
            silver_bar: 1,
            plat_coin: 1,
            pall_coin: 1
        };

        // Coin-specific modifiers (übliches Verhältnis zur Wiener Philharmoniker 1oz)
        // Werte <1 -> günstiger als Philharmoniker, >1 -> teurer
        const COIN_MODIFIERS = {
            // gold 1oz coins
            'g_phil_1': 1.00,   // Referenz (Wiener Philharmoniker)
            'g_krue_1': 0.97,   // Krügerrand meist günstiger
            'g_maple_1': 0.99,
            'g_brit_1': 1.01,
            'g_eagle_1': 0.995,
            'g_buff_1': 1.03,
            // smaller coins (we'll calculate pro gramm)
            'g_krue_05': 0.99
            // weitere können ergänzt werden
        };

        // --- KATALOG DATENBANK (ERWEITERT) ---
        const catalogDB = [
            // GOLD MÜNZEN
            { id: 'g_krue_1', name: 'Krügerrand 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_krue_05', name: 'Krügerrand 1/2 oz', metal: 'gold', type: 'coin', fine: 15.552 },
            { id: 'g_maple_1', name: 'Maple Leaf 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_brit_1', name: 'Britannia 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_phil_1', name: 'Wiener Philharmoniker 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_eagle_1', name: 'American Eagle 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_buff_1', name: 'American Buffalo 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_vren', name: 'Vreneli 20 Fr', metal: 'gold', type: 'coin', fine: 5.806 },
            { id: 'g_dukat', name: '1 Dukat Österreich', metal: 'gold', type: 'coin', fine: 3.44 },

            // GOLD BARREN
            { id: 'g_bar_100', name: 'Goldbarren 100g', metal: 'gold', type: 'bar', fine: 100.0 },
            { id: 'g_bar_50', name: 'Goldbarren 50g', metal: 'gold', type: 'bar', fine: 50.0 },
            { id: 'g_bar_1oz', name: 'Goldbarren 1 oz', metal: 'gold', type: 'bar', fine: 31.103 },
            { id: 'g_bar_10', name: 'Goldbarren 10g', metal: 'gold', type: 'bar', fine: 10.0 },

            // SILBER
            { id: 's_maple', name: 'Silber Maple Leaf 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_krue', name: 'Silber Krügerrand 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_phil', name: 'Silber Philharmoniker 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_eagle', name: 'Silber Eagle 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_bar_1kg', name: 'Silberbarren 1 kg', metal: 'silver', type: 'bar', fine: 1000.0 },
            { id: 's_bar_100', name: 'Silberbarren 100g', metal: 'silver', type: 'bar', fine: 100.0 },

            // PLATIN
            { id: 'pt_maple', name: 'Platin Maple Leaf 1 oz', metal: 'platinum', type: 'coin', fine: 31.103 },
            { id: 'pt_brit', name: 'Platin Britannia 1 oz', metal: 'platinum', type: 'coin', fine: 31.103 },
            { id: 'pt_bar_1', name: 'Platinbarren 1 oz', metal: 'platinum', type: 'bar', fine: 31.103 },

            // PALLADIUM
            { id: 'pd_maple', name: 'Palladium Maple Leaf 1 oz', metal: 'palladium', type: 'coin', fine: 31.103 },
            { id: 'pd_bar_1', name: 'Palladiumbarren 1 oz', metal: 'palladium', type: 'bar', fine: 31.103 }
        ];

        let portfolio = [];

        // --- INIT ---
        window.onload = function () {
            populateCatalog('all'); // Init catalog
            renderPrices();
            renderCoinComparison();
            renderPortfolio();
            buildMobileNav();
        };

        function checkPassword() {
            if (document.getElementById('passwordInput').value === "Magnetar9!") {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                renderPrices();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // --- NAVIGATION ---
        function switchView(viewId) {
            document.querySelectorAll('.hidden-section').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (viewId === 'dashboard') document.getElementById('nav-dash').classList.add('active');
            if (viewId === 'calculator') document.getElementById('nav-calc').classList.add('active');
            if (viewId === 'analysis') document.getElementById('nav-ana').classList.add('active');
            window.scrollTo(0, 0);
        }

        function toggleMobileNav() {
            const mn = document.getElementById('mobile-nav');
            mn.style.display = (mn.style.display === 'block') ? 'none' : 'block';
        }

        function buildMobileNav() {
            const mn = document.getElementById('mobile-nav');
            const items = document.querySelectorAll('.nav-item');
            mn.innerHTML = '';
            items.forEach(it => {
                const clone = it.cloneNode(true);
                clone.onclick = function () {
                    // trigger the original onclick
                    it.onclick();
                    document.getElementById('mobile-nav').style.display = 'none';
                };
                mn.appendChild(clone);
            });
        }

        // --- CORE MATH ---
        function calculateItemPrice(item) {
            // Spot per gram
            const spotPerOz = DAILY_SPOT_EUR[item.metal];
            const spotPerGram = spotPerOz / 31.1034768;

            // Premium/markup
            let premium = 1.0;
            if (item.metal === 'gold') premium = (item.type === 'coin') ? PREMIUMS.gold_coin : PREMIUMS.gold_bar;
            if (item.metal === 'silver') premium = (item.type === 'coin') ? PREMIUMS.silver_coin : PREMIUMS.silver_bar;
            if (item.metal === 'platinum') premium = PREMIUMS.plat_coin;
            if (item.metal === 'palladium') premium = PREMIUMS.pall_coin;

            // coin-specific modifier (relative to reference coin)
            const coinModifier = (item.type === 'coin' && COIN_MODIFIERS[item.id]) ? COIN_MODIFIERS[item.id] : 1.0;

            // Final price: fine * spot/g * premium * coinModifier
            return item.fine * spotPerGram * premium * coinModifier;
        }

        function formatMoney(val) { return val.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }); }

        // --- UI FUNCTIONS ---
        function renderPrices() {
            // Show Philharmoniker as reference for gold 1oz
            const phil = catalogDB.find(i => i.id === 'g_phil_1');
            const philPrice = (phil) ? calculateItemPrice(phil) : (DAILY_SPOT_EUR.gold * PREMIUMS.gold_coin);
            document.getElementById('dash-gold').innerText = formatMoney(philPrice);

            // Silver / Plat / Pall (take representative 1oz coin/barren)
            const silver1 = catalogDB.find(i => i.id === 's_maple') || { metal: 'silver' };
            const plat1 = catalogDB.find(i => i.id === 'pt_maple') || { metal: 'platinum' };
            const pall1 = catalogDB.find(i => i.id === 'pd_maple') || { metal: 'palladium' };

            document.getElementById('dash-silver').innerText = formatMoney(calculateItemPrice(silver1));
            document.getElementById('dash-plat').innerText = formatMoney(calculateItemPrice(plat1));
            document.getElementById('dash-pall').innerText = formatMoney(calculateItemPrice(pall1));

            document.getElementById('update-date').innerText = LAST_UPDATE;
        }

        // Render a small comparison list of common 1oz gold coins relative to Philharmoniker
        function renderCoinComparison() {
            const compareIds = ['g_phil_1', 'g_krue_1', 'g_maple_1', 'g_brit_1', 'g_eagle_1', 'g_buff_1'];
            const container = document.getElementById('coin-compare');
            container.innerHTML = '';
            compareIds.forEach(id => {
                const item = catalogDB.find(i => i.id === id);
                if (!item) return;
                const price = calculateItemPrice(item);
                const el = document.createElement('div');
                el.style.display = 'flex'; el.style.justifyContent = 'space-between'; el.style.alignItems = 'center';
                el.innerHTML = `<div style="font-weight:600; color:#fff; font-size:0.95rem;">${item.name}</div><div style='text-align:right; font-size:0.95rem; color:var(--c-primary);'>${formatMoney(price)}</div>`;
                container.appendChild(el);
            });
        }

        // --- CALCULATOR LOGIC ---
        function toggleCalcMode(mode) {
            document.getElementById('mode-catalog').style.display = (mode === 'catalog') ? 'block' : 'none';
            document.getElementById('mode-raw').style.display = (mode === 'raw') ? 'block' : 'none';
            document.getElementById('tab-cat').classList.toggle('active', mode === 'catalog');
            document.getElementById('tab-raw').classList.toggle('active', mode === 'raw');
        }

        function filterCatalog(metalType) { populateCatalog(metalType); }

        function populateCatalog(filter) {
            const sel = document.getElementById('catalogSelect'); sel.innerHTML = ""; // Clear

            catalogDB.forEach(item => {
                if (filter === 'all' || item.metal === filter) {
                    let opt = document.createElement('option');
                    opt.value = item.id; opt.text = item.name; sel.appendChild(opt);
                }
            });
            // ensure there's a selected option
            if (sel.options && sel.options.length > 0) sel.selectedIndex = 0;
            updateCatDetails();
        }

        function updateCatDetails() {
            const sel = document.getElementById('catalogSelect');
            const id = sel.value || (sel.options[0] && sel.options[0].value);
            if (!id) return;
            const item = catalogDB.find(x => x.id === id);
            if (!item) return;
            const price = calculateItemPrice(item);
            document.getElementById('cat-price-display').value = formatMoney(price);
        }

        function addToPortfolio() {
            let itemToAdd = {};
            let spreadVal = parseFloat(document.getElementById('spread-select').value);

            // detect mode by tab active state (reliable even if style.display is '')
            const catalogMode = document.getElementById('tab-cat').classList.contains('active');

            if (catalogMode) {
                const id = document.getElementById('catalogSelect').value;
                const qty = parseInt(document.getElementById('cat-qty').value) || 1;
                const dbItem = catalogDB.find(x => x.id === id);
                if (!dbItem) return alert('Kein Produkt gewählt');

                // Basispreis berechnen (Händler VK)
                let basePrice = calculateItemPrice(dbItem);

                // Wenn Benutzer "Spot" gewählt hat (0.0), rechnen wir Rückwärts den Premium raus
                if (parseFloat(document.getElementById('spread-select').value) === 0.0) {
                    const spotPerOz = DAILY_SPOT_EUR[dbItem.metal];
                    basePrice = dbItem.fine * (spotPerOz / 31.1034768);
                    spreadVal = 1.0; // weil basePrice jetzt Spot ist
                }

                itemToAdd = {
                    name: dbItem.name,
                    metal: dbItem.metal,
                    singleVal: basePrice,
                    qty: qty,
                    spread: spreadVal
                };
            } else {
                // Raw Modus
                const metal = document.getElementById('raw-metal').value;
                const weight = parseFloat(document.getElementById('raw-weight').value);
                const purity = parseFloat(document.getElementById('raw-purity').value);

                if (!weight || weight <= 0) return alert("Gewicht fehlt oder ungültig");

                const spotPerOz = DAILY_SPOT_EUR[metal];
                const spotPerGram = spotPerOz / 31.1034768;

                let basePrice = (weight * purity) * spotPerGram;

                itemToAdd = {
                    name: `Manuell (${metal.toUpperCase()})`,
                    metal: metal,
                    singleVal: basePrice,
                    qty: 1,
                    spread: (parseFloat(document.getElementById('spread-select').value) === 0.0) ? 1.0 : spreadVal
                };
            }

            portfolio.push(itemToAdd);
            renderPortfolio();
        }

        function renderPortfolio() {
            const container = document.getElementById('portfolio-container');
            let total = 0;

            if (portfolio.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--c-text-muted); padding-top: 40px;">Noch keine Positionen.</p>';
                document.getElementById('total-value').innerText = formatMoney(0);
                document.getElementById('port-count').innerText = "0 Positionen";
                return;
            }

            let html = '<div class="inventory-list">';

            portfolio.forEach((item, index) => {
                const totalItemVal = item.singleVal * item.qty * item.spread;
                total += totalItemVal;

                let spreadLabel = "";
                if (item.spread < 1.0 && item.spread > 0.8) spreadLabel = '<span style="font-size:0.7rem; color:var(--c-text-muted)">(Ankaufswert)</span>';

                let iconColor = '#fff';
                if (item.metal === 'gold') iconColor = 'var(--color-gold)';
                if (item.metal === 'silver') iconColor = 'var(--color-silver)';
                if (item.metal === 'platinum') iconColor = 'var(--color-plat)';
                if (item.metal === 'palladium') iconColor = 'var(--color-pall)';

                html += `\n                    <div class="inventory-item">\n                        <div style="display:flex; align-items:center; gap:10px;">\n                            <i class="fa-solid fa-circle" style="font-size:0.5rem; color:${iconColor};"></i>\n                            <div>\n                                <div style="font-weight:600; color:#fff;">${item.name}</div>\n                                <div style="font-size:0.8rem; color:var(--c-text-muted);">\n                                    ${item.qty} Stück ${spreadLabel}\n                                </div>\n                            </div>\n                        </div>\n                        <div style="text-align:right;">\n                            <div style="font-weight:600; color:var(--c-primary);">${formatMoney(totalItemVal)}</div>\n                            <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--c-text-muted); font-size:0.8rem; margin-top:5px;" onclick="removeFromPortfolio(${index})"></i>\n                        </div>\n                    </div>`;
            });

            html += '</div>';
            container.innerHTML = html;

            document.getElementById('total-value').innerText = formatMoney(total);
            document.getElementById('port-count').innerText = portfolio.length + " Positionen";
        }

        function removeFromPortfolio(idx) { portfolio.splice(idx, 1); renderPortfolio(); }
        function clearPortfolio() { portfolio = []; renderPortfolio(); }

    </script>
</body>
</html>
